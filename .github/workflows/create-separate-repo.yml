name: Create Separate Repository

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Name of the generated project to create repo for'
        required: true
      repo_visibility:
        description: 'Repository visibility'
        required: true
        default: 'private'
        type: choice
        options:
          - private
          - public
      target_org:
        description: 'Target organization (leave empty for personal account)'
        required: false

jobs:
  create-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify project exists
        id: verify
        run: |
          PROJECT_PATH="generated-projects/${{ github.event.inputs.project_name }}"
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "âŒ Project not found: $PROJECT_PATH"
            exit 1
          fi
          echo "âœ… Project found: $PROJECT_PATH"
          echo "project_path=$PROJECT_PATH" >> $GITHUB_OUTPUT
      
      - name: Create new repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_NAME="${{ github.event.inputs.project_name }}"
          VISIBILITY="${{ github.event.inputs.repo_visibility }}"
          TARGET_ORG="${{ github.event.inputs.target_org }}"
          
          # Determine if creating in org or personal account
          if [ -n "$TARGET_ORG" ]; then
            REPO_FULL_NAME="$TARGET_ORG/$PROJECT_NAME"
            gh repo create "$REPO_FULL_NAME" --$VISIBILITY --description "Generated by CodeGen Automator"
          else
            gh repo create "$PROJECT_NAME" --$VISIBILITY --description "Generated by CodeGen Automator"
            REPO_FULL_NAME="${{ github.repository_owner }}/$PROJECT_NAME"
          fi
          
          echo "Created repository: $REPO_FULL_NAME"
          echo "repo_full_name=$REPO_FULL_NAME" >> $GITHUB_OUTPUT
        id: create_repo
      
      - name: Push project to new repository
        run: |
          PROJECT_PATH="${{ steps.verify.outputs.project_path }}"
          REPO_FULL_NAME="${{ steps.create_repo.outputs.repo_full_name }}"
          
          cd "$PROJECT_PATH"
          
          # Initialize git if not already
          if [ ! -d .git ]; then
            git init
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
          fi
          
          # Add all files
          git add .
          git commit -m "Initial commit from CodeGen Automator" || echo "Nothing to commit"
          
          # Add remote and push
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$REPO_FULL_NAME.git"
          git branch -M main
          git push -u origin main
          
          echo "âœ… Project pushed to https://github.com/$REPO_FULL_NAME"
      
      - name: Add project README updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_FULL_NAME="${{ steps.create_repo.outputs.repo_full_name }}"
          
          # Add topics to the repository
          gh repo edit "$REPO_FULL_NAME" \
            --add-topic "codegen-automator" \
            --add-topic "auto-generated"
          
          echo "âœ… Repository configured successfully"
          echo "ðŸ”— Repository URL: https://github.com/$REPO_FULL_NAME"
