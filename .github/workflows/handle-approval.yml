name: Handle Approval and Create PR

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  handle-approval:
    name: Process Approval/Rejection
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'auto-generate') &&
      (contains(github.event.comment.body, '/approve') || contains(github.event.comment.body, '/reject'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Get issue metadata
        id: metadata
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issueNumber = context.payload.issue.number;
            
            // Read metadata file
            const metadataPath = `.codegen-metadata/issue-${issueNumber}.json`;
            
            try {
              const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf8'));
              core.setOutput('project_name', metadata.project_name);
              core.setOutput('project_type', metadata.project_type);
              core.setOutput('branch', metadata.branch);
              return metadata;
            } catch (error) {
              core.setFailed(`Could not read metadata file: ${error.message}`);
            }
            
      - name: Handle approval
        if: contains(github.event.comment.body, '/approve')
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const branchName = `${{ steps.metadata.outputs.branch }}`;
            const projectName = `${{ steps.metadata.outputs.project_name }}`;
            const projectType = `${{ steps.metadata.outputs.project_type }}`;
            
            // Create Pull Request
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CodeGen] ${projectType}: ${projectName}`,
              head: branchName,
              base: 'main',
              body: `## Auto-Generated Project\n\n` +
                    `ü§ñ This PR was automatically generated based on issue #${issueNumber}\n\n` +
                    `**Project Details:**\n` +
                    `- Type: \`${projectType}\`\n` +
                    `- Name: \`${projectName}\`\n` +
                    `- Branch: \`${branchName}\`\n\n` +
                    `**Generated by:** CodeGen Automator\n\n` +
                    `Closes #${issueNumber}`
            });
            
            // Comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Approved!**\n\n` +
                    `Pull Request created: #${pr.data.number}\n` +
                    `Link: ${pr.data.html_url}\n\n` +
                    `Please review and merge when ready.`
            });
            
            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['approved', 'pr-created']
            });
            
      - name: Handle rejection
        if: contains(github.event.comment.body, '/reject')
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const branchName = `${{ steps.metadata.outputs.branch }}`;
            
            // Delete branch
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
            } catch (error) {
              core.warning(`Could not delete branch: ${error.message}`);
            }
            
            // Comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚ùå **Rejected**\n\n` +
                    `The generated code has been rejected.\n` +
                    `Branch \`${branchName}\` has been deleted.\n\n` +
                    `This issue will be closed.`
            });
            
            // Close issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              labels: ['rejected']
            });
